#!/usr/bin/env zsh
set -euo pipefail

# Colours
green() { printf "\033[32m%s\033[0m\n" "$*"; }
red() { printf "\033[31m%s\033[0m\n" "$*" >&2; }

# Bootstrap Debian 12 (bookworm)
green "Updating apt..."
sudo apt update

green "Installing packages..."
sudo apt install -y \
  ca-certificates \
  curl \
  gnupg \
  lsb-release \
  build-essential \
  git \
  zsh \
  tmux \
  fzf \
  unzip \
  jq \
  python3 \
  python3-venv \
  python3-pip \
  direnv \
  nodejs \
  npm \
  libffi-dev \
  libyaml-dev \
  libssl-dev \
  libreadline-dev \
  zlib1g-dev \
  libpam-ssh-agent-auth \
  gh

# Set default shell to zsh if not already
if [ "$SHELL" != "$(command -v zsh)" ]; then
  green "Setting default shell to zsh..."
  chsh -s "$(command -v zsh)"
fi

# Reduce SSH latency (only if not already configured)
if ! grep -q "^UseDNS no" /etc/ssh/sshd_config 2>/dev/null; then
  green "Configuring SSH for reduced latency..."
  echo "UseDNS no" | sudo tee -a /etc/ssh/sshd_config
  sudo systemctl restart ssh
fi

# Configure Touch ID sudo via SSH agent forwarding
# This allows using macOS Touch ID for sudo on remote servers
if [ ! -f /etc/sudoers.d/ssh-agent-auth ]; then
  green "Configuring SSH agent auth for sudo (Touch ID forwarding)..."

  # Preserve SSH_AUTH_SOCK in sudo environment
  echo 'Defaults env_keep += "SSH_AUTH_SOCK"' | sudo tee /etc/sudoers.d/ssh-agent-env >/dev/null
  sudo chmod 440 /etc/sudoers.d/ssh-agent-env

  # Add PAM config for SSH agent auth (must be before other auth methods)
  echo "auth sufficient pam_ssh_agent_auth.so file=~/.ssh/authorized_keys" | sudo tee /etc/pam.d/sudo-ssh-agent >/dev/null

  # Include the SSH agent auth in sudo PAM config if not already present
  if ! grep -q "pam_ssh_agent_auth" /etc/pam.d/sudo 2>/dev/null; then
    sudo sed -i '1a auth sufficient pam_ssh_agent_auth.so file=~/.ssh/authorized_keys' /etc/pam.d/sudo
  fi

  # Mark as configured
  sudo touch /etc/sudoers.d/ssh-agent-auth
fi

# Install mise if not present
if ! command -v mise >/dev/null 2>&1; then
  green "Installing mise..."
  curl -fsSL https://mise.jdx.dev/install.sh | sh
fi

# Install Claude Code globally via npm
if ! command -v claude >/dev/null 2>&1; then
  green "Installing Claude Code..."
  sudo npm install -g @anthropic-ai/claude-code
fi

# Ensure mise is in PATH for this session
export PATH="${HOME}/.local/bin:${PATH}"

# Verify mise installation
green "Verifying mise installation..."
mise doctor

# Install mise dependencies
green "Installing mise dependencies..."
mise install -y

echo
green "2-bootstrap-debian complete."
echo

# Pause for confirmation before proceeding
if [ -r /dev/tty ]; then
  printf "Press Enter to continue to the next step..." >&2
  read -r </dev/tty
fi
