#!/usr/bin/env zsh
set -euo pipefail

# Colours
green() { printf "\033[32m%s\033[0m\n" "$*"; }
red() { printf "\033[31m%s\033[0m\n" "$*" >&2; }

# Bootstrap Debian 12 (bookworm)
green "Updating apt..."
sudo apt update

green "Installing packages..."
sudo apt install -y \
  ca-certificates \
  curl \
  gnupg \
  lsb-release \
  build-essential \
  git \
  zsh \
  tmux \
  fzf \
  unzip \
  jq \
  python3 \
  python3-venv \
  python3-pip \
  direnv \
  nodejs \
  npm \
  libffi-dev \
  libyaml-dev \
  libssl-dev \
  libreadline-dev \
  zlib1g-dev

# Set default shell to zsh if not already
if [ "$SHELL" != "$(command -v zsh)" ]; then
  green "Setting default shell to zsh..."
  chsh -s "$(command -v zsh)"
fi

# Reduce SSH latency (only if not already configured)
if ! grep -q "^UseDNS no" /etc/ssh/sshd_config 2>/dev/null; then
  green "Configuring SSH for reduced latency..."
  echo "UseDNS no" | sudo tee -a /etc/ssh/sshd_config
  sudo systemctl restart ssh
fi

# Install mise if not present
if ! command -v mise >/dev/null 2>&1; then
  green "Installing mise..."
  curl -fsSL https://mise.jdx.dev/install.sh | sh
fi

# Ensure mise is in PATH for this session
export PATH="${HOME}/.local/bin:${PATH}"

# Activate mise for this session
eval "$(mise activate zsh)"

# Verify mise installation
green "Verifying mise installation..."
mise doctor

# Install mise dependencies
green "Installing mise dependencies..."
mise install -y

echo
green "2-bootstrap-debian complete."
echo

# Pause for confirmation before proceeding
if [ -r /dev/tty ]; then
  printf "Press Enter to continue to the next step..." >&2
  read -r </dev/tty
fi
