#!/usr/bin/env bash
set -euo pipefail

# Bootstrap Debian 12 (bookworm)
echo "Updating apt..."
sudo apt update

echo "Installing packages..."
sudo apt install -y \
  ca-certificates \
  curl \
  gnupg \
  lsb-release \
  build-essential \
  git \
  zsh \
  tmux \
  fzf \
  unzip \
  jq \
  python3 \
  python3-venv \
  python3-pip \
  direnv \
  nodejs \
  npm

# Set default shell to zsh if not already
if [ "$SHELL" != "$(command -v zsh)" ]; then
  echo "Setting default shell to zsh..."
  chsh -s "$(command -v zsh)"
fi

# Reduce SSH latency (only if not already configured)
if ! grep -q "^UseDNS no" /etc/ssh/sshd_config 2>/dev/null; then
  echo "Configuring SSH for reduced latency..."
  echo "UseDNS no" | sudo tee -a /etc/ssh/sshd_config
  sudo systemctl restart ssh
fi

# Install mise if not present
if ! command -v mise >/dev/null 2>&1; then
  echo "Installing mise..."
  curl -fsSL https://mise.jdx.dev/install.sh | sh
fi

# Ensure mise is in PATH for this session
export PATH="${HOME}/.local/bin:${PATH}"

# Activate mise for this session
eval "$(mise activate bash)"

# Verify mise installation
echo "Verifying mise installation..."
mise doctor

# Install mise dependencies
mise install -y

echo
echo "2-bootstrap-debian complete."
echo

# Pause for confirmation before proceeding
if [ -r /dev/tty ]; then
  printf "Press Enter to continue to the next step..." >&2
  read -r </dev/tty
fi
