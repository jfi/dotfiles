#!/usr/bin/env zsh
set -euo pipefail

# Colours
green() { printf "\033[32m%s\033[0m\n" "$*"; }
red() { printf "\033[31m%s\033[0m\n" "$*" >&2; }

# Ensure mise is in PATH (may have just been installed)
export PATH="${HOME}/.local/bin:${PATH}"

# Activate mise for this session
eval "$(mise activate zsh)"

# Install latest stable Ruby via mise
green "Installing latest stable Ruby via mise..."
LATEST_RUBY=$(mise ls-remote ruby | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | tail -1)
mise use --global ruby@$LATEST_RUBY
green "Installed Ruby $LATEST_RUBY"

# Update RubyGems and install latest Bundler
green "Updating RubyGems..."
gem update --system --no-document
green "Installing latest Bundler..."
gem install bundler --no-document

echo
green "3-install-ruby complete."
echo
echo "Ruby $(ruby --version)"
echo "RubyGems $(gem --version)"
echo "Bundler $(bundle --version)"
echo

# Pause for confirmation before proceeding
if [ -r /dev/tty ]; then
  printf "Press Enter to continue..." >&2
  read -r </dev/tty
fi
