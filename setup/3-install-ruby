#!/usr/bin/env bash
set -euo pipefail

# Colours
green() { printf "\033[32m%s\033[0m\n" "$*"; }
red() { printf "\033[31m%s\033[0m\n" "$*" >&2; }

# Ensure mise is in PATH (may have just been installed)
export PATH="${HOME}/.local/bin:${PATH}"

# Activate mise for this session
eval "$(mise activate bash)"

# Install latest stable Ruby via mise
green "Installing latest stable Ruby via mise..."
LATEST_RUBY=$(mise ls-remote ruby | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | tail -1)
mise use --global "ruby@${LATEST_RUBY}"
green "Installed Ruby ${LATEST_RUBY}"

# Reshim to make ruby/gem available
eval "$(mise activate bash)"
eval "$(mise hook-env -s bash)"

# Update RubyGems and install latest Bundler
green "Updating RubyGems..."
mise exec -- gem update --system --no-document
green "Installing latest Bundler..."
mise exec -- gem install bundler --no-document

echo
green "3-install-ruby complete."
echo
mise exec -- ruby --version
mise exec -- gem --version
mise exec -- bundle --version
echo

# Pause for confirmation before proceeding
if [ -r /dev/tty ]; then
  printf "Press Enter to continue..." >&2
  read -r </dev/tty
fi
