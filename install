#!/usr/bin/env bash
set -euo pipefail

# Colours
green() { printf "\033[32m%s\033[0m\n" "$*"; }
red() { printf "\033[31m%s\033[0m\n" "$*" >&2; }

OS="$(uname -s)"
DOTFILES_REPO="${DOTFILES_REPO:-}"
DOTFILES_DIR="${HOME}/.dotfiles"

bootstrap_macos() {
  # Install XCode Command Line Tools if necessary
  if ! command -v xcode-select >/dev/null 2>&1 || ! xcode-select -p >/dev/null 2>&1; then
    green "Installing XCode Command Line Tools..."
    xcode-select --install
    echo "Please complete the XCode installation in the dialog that appeared." >&2
    exit 0
  fi

  # Install Homebrew if necessary
  if ! command -v brew >/dev/null 2>&1; then
    green "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
    # shellcheck disable=SC2016
    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> "${HOME}/.zprofile"
  fi

  # Install 1Password CLI if necessary
  if ! command -v op >/dev/null 2>&1; then
    green "Installing 1Password CLI..."
    brew install --cask 1password
    brew install 1password-cli
    read -r -p "Open 1Password, log in, go to Settings > Developer, enable CLI & SSH Agent. Press enter when done: " -t 300 || true
  fi

  # Set SSH clone URL for macOS (uses 1Password SSH agent)
  DOTFILES_REPO="${DOTFILES_REPO:-git@github.com:jfi/dotfiles.git}"
}

bootstrap_linux() {
  # Assume git already available on Linux distros
  DOTFILES_REPO="${DOTFILES_REPO:-https://github.com/jfi/dotfiles.git}"
}

# Bootstrap OS-specific requirements
case "${OS}" in
  Darwin)
    bootstrap_macos
    ;;
  Linux)
    bootstrap_linux
    ;;
  *)
    red "ERROR: Unsupported OS: ${OS}"
    exit 1
    ;;
esac

# Clone repo if not present
if [ ! -d "${DOTFILES_DIR}" ]; then
  if ! command -v git >/dev/null 2>&1; then
    red "ERROR: git is required but not installed"
    exit 1
  fi

  green "Cloning dotfiles to ${DOTFILES_DIR}..."
  git clone "${DOTFILES_REPO}" "${DOTFILES_DIR}"
fi

# Run setup scripts in order (with TTY for interactive prompts)
green "Running setup scripts..."

# 1-init: always runs first (shell config, git config, etc.)
"${DOTFILES_DIR}/setup/1-init" </dev/tty

# 2-bootstrap: OS-specific package installation
case "${OS}" in
  Darwin)
    "${DOTFILES_DIR}/setup/2-bootstrap-macos" </dev/tty
    ;;
  Linux)
    "${DOTFILES_DIR}/setup/2-bootstrap-debian" </dev/tty
    ;;
esac

# 3-install-ruby: Ruby via mise (runs on all platforms)
"${DOTFILES_DIR}/setup/3-install-ruby" </dev/tty

green "Setup complete!"
