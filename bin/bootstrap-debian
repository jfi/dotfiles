#!/usr/bin/env bash
set -euo pipefail

# Bootstrap Debian 12 (bookworm)
sudo apt update
sudo apt install -y \
  ca-certificates \
  curl \
  gnupg \
  lsb-release \
  build-essential \
  git \
  zsh \
  tmux \
  fzf \
  unzip \
  jq \
  python3 \
  python3-venv \
  python3-pip \
  direnv

# Set default shell to zsh
chsh -s "$(command -v zsh)"

# Reduce SSH latency
echo "UseDNS no" | sudo tee -a /etc/ssh/sshd_config
sudo systemctl restart ssh

# Install Tailscale
curl -fsSL https://tailscale.com/install.sh | sh
sudo tailscale up

# Install 1Password CLI
curl -fsSL https://downloads.1password.com/linux/keys/1password.asc | \
  sudo gpg --dearmor -o /usr/share/keyrings/1password-archive-keyring.gpg

echo "deb [arch=amd64 signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] \
https://downloads.1password.com/linux/debian stable main" | \
  sudo tee /etc/apt/sources.list.d/1password.list

sudo apt update
sudo apt install -y 1password-cli

# Sign in to 1Password
eval "$(op signin)"

# Clone the repository
git clone https://github.com/jfi/dotfiles.git ~/.dotfiles
cd ~/.dotfiles

# Run setup
./setup
