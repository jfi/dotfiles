#!/usr/bin/env bash
set -euo pipefail

warn()  { printf "⚠️  %s\n" "$*"; }
ok()    { printf "✅ %s\n" "$*"; }
info()  { printf "ℹ️  %s\n" "$*"; }

failures=0

check() {
  if "$@"; then
    return 0
  else
    failures=$((failures + 1))
    return 1
  fi
}

info "Server baseline health check"
echo

# --- OS -----------------------------------------------------
if [ -f /etc/os-release ]; then
  . /etc/os-release
  ok "OS: ${PRETTY_NAME}"
else
  warn "Cannot determine OS"
fi

# --- Time sync ---------------------------------------------
if timedatectl show -p NTPSynchronized --value 2>/dev/null | grep -q yes; then
  ok "Time synchronized (NTP)"
else
  warn "Time is NOT synchronized"
  failures=$((failures + 1))
fi

# --- Timezone ----------------------------------------------
TZ="$(timedatectl show -p Timezone --value 2>/dev/null || true)"
if [ -n "${TZ}" ]; then
  ok "Timezone: ${TZ}"
else
  warn "Timezone not set or unknown"
  failures=$((failures + 1))
fi

# --- SSH hardening -----------------------------------------
SSHD_CFG="/etc/ssh/sshd_config"
if [ -f "${SSHD_CFG}" ]; then
  grep -Eq '^PermitRootLogin\s+no' "${SSHD_CFG}" \
    && ok "SSH root login disabled" \
    || warn "SSH root login may be enabled"

  grep -Eq '^PasswordAuthentication\s+no' "${SSHD_CFG}" \
    && ok "SSH password auth disabled" \
    || warn "SSH password authentication may be enabled"
else
  warn "sshd_config not found"
fi

# --- Firewall ----------------------------------------------
if command -v ufw >/dev/null 2>&1; then
  if ufw status | grep -q "Status: active"; then
    ok "UFW firewall active"
  else
    warn "UFW installed but not active"
    failures=$((failures + 1))
  fi
else
  warn "UFW not installed"
fi

# --- Updates -----------------------------------------------
if systemctl is-enabled unattended-upgrades >/dev/null 2>&1; then
  ok "Unattended upgrades enabled"
else
  warn "Unattended upgrades not enabled"
fi

# --- Users --------------------------------------------------
if [ "$(id -u)" -ne 0 ]; then
  ok "Running as non-root user ($(whoami))"
else
  warn "Running as root"
  failures=$((failures + 1))
fi

# --- Summary -----------------------------------------------
echo
if [ "${failures}" -eq 0 ]; then
  ok "Baseline looks good"
else
  warn "Baseline issues detected: ${failures}"
fi

exit "${failures}"
